<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="static/styles/style_for_map.css">
	<title>Карта точек тестирования</title>
    <script>
		const PIN_WIDTH = 30;
		const COLORS = {0: "magenta",
						1: "purple",
						2: "red",
						3: "blue",
						4: "orange"};
		var hovered_pin_type;
		var mouse_x, mouse_y;
		document.addEventListener("mousemove", (event) => {
			mouse_x = event.clientX;
			mouse_y = event.clientY;
		});
		
        /**
         * Function changes position of image of IV-curve for pin.
         * @param pin_iv_img: image of IV-curve for pin.
         */
        function change_position(pin_iv_img) {
            pin_iv_img.style.top = "60%";
        }
		
		/**
		 * Function checks if mouse is inside image of IV-curve.
		 * @param object: image of IV-curve.
		 * @return: true if mouse is inside image of IV-curve.
		 */
		function check_point_inside(object) {
			const PERCENT = 0.2;
			let body = document.getElementsByTagName("body")[0];
			let body_width = body.getBoundingClientRect().width;
			let img_width = PERCENT * body_width;
			let img_height = object.naturalHeight * img_width / object.naturalWidth;
			if (0 <= mouse_x && mouse_x <= img_width && 0 <= mouse_y && mouse_y <= img_height)
				return true;
			return false;
		}

        /**
         * Function hides or shows image of IV-curve for pin.
         * @param pin: area on big image of board that represents pin;
         * @param show: if false image is hidden;
		 * @param pin_type: type of pin.
         */
        function hide_or_show_img(pin, show, pin_type = null) {
			let hovered_pin = document.getElementById("pin");
			let coords = pin.getAttribute("coords");
			if (pin != hovered_pin && show) {
				hovered_pin_type = pin_type;
				hovered_pin.setAttribute("coords", coords);
			}
			else if (!show)
				hovered_pin.setAttribute("coords", "0,0,15");
            let pin_iv_img = document.getElementById("img" + coords);
			let board_x = document.getElementById("board_img").getBoundingClientRect().x;
			if (board_x < 0)
				board_x = 0;
            if (show) {
				if (check_point_inside(pin_iv_img))
					change_position(pin_iv_img);
                pin_iv_img.style.display = "block";
				let coords_array = coords.split(",");
				hovered_pin.style.backgroundColor = COLORS[hovered_pin_type];
				hovered_pin.style.left = parseFloat(coords_array[0]) + board_x - PIN_WIDTH / 2 + "px";
				hovered_pin.style.top = parseFloat(coords_array[1]) - PIN_WIDTH / 2 + "px";
				hovered_pin.style.visibility = "visible";
			}
            else {
                pin_iv_img.style.display = "none";
                pin_iv_img.style.top = "0px";
				hovered_pin.style.left = "0px";
				hovered_pin.style.top = "0px";
				hovered_pin.style.visibility = "hidden";
            }
        }

        window.onresize = function() {
            let imgs = document.getElementsByTagName("figure");
            for (let i = 0; i < imgs.length; i++) {
                let pin_iv_img = imgs[i];
                pin_iv_img.style.width = "20%";
            }
        }
    </script>
</head>

<body>
    <center>
		<img id="board_img" src="static/img/board.png" usemap="#map">
			<div id="pin" onmouseover="hide_or_show_img(this, true);" onmouseout="hide_or_show_img(this, false);" coords="0,0,15">
			</div>
		</img>
	</center>
    <p>
		<map name="map">
			% for name, element_index, pin_index, x, y, _, _, pin_type, _, _ in pins:
			<area onmouseover="hide_or_show_img(this, true, ${pin_type.value});" shape="circle" coords="${x},${y},10" href="#point${x}${y}" alt="">
			% endfor
		</map>
	</p>
    % for name, element_index, pin_index, x, y, measurements, _, pin_type, _, _ in pins:
	<figure id="img${x},${y},10" onmouseover="change_position(this);" style="display: none;">
		<p>
			<img src="static/img/${'%s_%s_%s_iv.png'%(name, element_index, pin_index)}" alt="Изображение ВАХв точке тестирования">
		</p>
		<%
			legend_for_iv_img = ""
			if len(measurements) > 1:
				legend_for_iv_img += "Оранжевый - справочная ВАХ\n"
			if pin_type.value == 0:
				legend_for_iv_img += "Пурпурный - тестовая ВАХ (динамическая)"
			elif pin_type.value == 2:
				legend_for_iv_img += f"Красный - тестовая ВАХ (score больше порогового значения {threshold_score * 100}%)"
			elif pin_type.value == 3:
				legend_for_iv_img += "Синий - тестовая ВАХ"
		%>
		<figcaption>${legend_for_iv_img}</figcaption>
	</figure>
	% endfor
</body>

</html>
